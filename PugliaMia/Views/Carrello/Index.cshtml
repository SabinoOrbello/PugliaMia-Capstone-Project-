@model List<PugliaMia.Models.Prodotti>

<h2>Prodotti nel Carrello</h2>

@if (Model.Any())
{
    using (Html.BeginForm("CreaOrdine", "Ordini", FormMethod.Post))
    {
        <div class="container">
            @foreach (var prodotto in Model)
            {
                <div class="card">
                    <div class="card-body">
                        <h5 class="card-title">@prodotto.Nome</h5>
                        <img src="@Url.Content(string.IsNullOrEmpty(prodotto.Immagine) ? "~/Content/Images/hotel.jpg" : prodotto.Immagine)" class="card-img-top w-25" alt="...">
                        <p class="card-text">Prezzo: @prodotto.Prezzo €</p>
                        <b>Seleziona quantità</b>
                        <input type="number" name="quantita_@prodotto.ProdottoID" min="1" value="1" data-prezzo="@prodotto.Prezzo" class="quantita-prodotto form-control mb-2">
                        <input type="hidden" name="prodottoID" value="@prodotto.ProdottoID" />
                        <button type="button" class="btn btn-danger mb-2" onclick="rimuoviProdotto(@prodotto.ProdottoID)">Elimina</button>                     
                    </div>
                </div>

            }
        </div>
        <div>
            <strong>Totale della spesa:</strong> <span id="totaleSpesa">@ViewBag.TotaleSpesa €</span>
        </div>

        <div class="form-group">
            <button type="button" class="btn btn-primary" onclick="mostraForm()">Procedi con l'acquisto</button>
            <p>@Html.ActionLink("Continua gli Acquisti", "Index", "Categorie", new { area = "" }, new { @class = "btn btn-success" })</p>
        </div>

        <div class="row" id="formSpedizione" style="display: none;">
            <!-- Dati Spedizione (Colonna sinistra) -->
            <div class="col-md-6">
                <h3>Dati Spedizione</h3>
                <div class="form-group">
                    <label for="indirizzoSpedizione">Indirizzo di spedizione</label>
                    <input type="text" class="form-control" id="indirizzoSpedizione" name="indirizzoSpedizione" required>
                    <label for="corriere">Corriere</label>
                    <select class="form-control" id="corriere" name="corriere" required>
                        <option value="">Seleziona un corriere</option>
                        <option value="Fedex">Fedex</option>
                        <option value="SDA">SDA</option>
                        <option value="GLS">GLS</option>
                        <option value="DHL">DHL</option>
                    </select>
                </div>
            </div>
        </div>

        <div class="row" id="formFatturazione" style="display: none;">
            <!-- Dati Fatturazione (Colonna destra) -->
            <div class="col-md-6">
                <h3>Dati Fatturazione</h3>
                <div class="form-group">
                    <label for="metodoPagamento">Metodo di pagamento</label>
                    <select class="form-control" id="metodoPagamento" name="metodoPagamento" required>
                        <option value="">Seleziona un metodo di pagamento</option>
                        <option value="Carta di credito">Carta di credito</option>
                        <option value="PayPal">PayPal</option>
                    </select>

                    <div class="form-group">
                        <label for="numeroCarta">Numero della Carta</label>
                        <input type="text" class="form-control" id="numeroCarta" name="numeroCarta" placeholder="Inserisci il numero della carta" required>
                    </div>

                    <div class="form-group">
                        <label for="dataScadenzaCarta">Data di scadenza della carta (MM/AA)</label>
                        <input type="text" class="form-control" id="dataScadenzaCarta" name="dataScadenzaCarta" placeholder="MM/AA" required>
                        <small class="form-text text-muted">Formato richiesto: MM/AA</small>
                    </div>


                    <div class="form-group">
                        <label for="cvv">CVV</label>
                        <input type="text" class="form-control" id="cvv" name="cvv" placeholder="Inserisci il CVV" required>
                    </div>
                </div>
            </div>
        </div>
        <div class="form-group">
            <button type="submit" class="btn btn-primary">Conferma ordine</button>
        </div>

        


        <script>
            function mostraForm() {
                document.getElementById("formSpedizione").style.display = "block";
                document.getElementById("formFatturazione").style.display = "block";
            }
             function rimuoviProdotto(prodottoId) {
        // Fai una richiesta AJAX per rimuovere il prodotto dal carrello
        $.ajax({
            url: '@Url.Action("Rimuovi", "Carrello")',
            type: 'POST',
            data: { prodottoId: prodottoId },
            success: function (response) {
                // Se la rimozione è avvenuta con successo, aggiorna la pagina del carrello
                location.reload();
            },
            error: function (xhr, status, error) {
                // Se si verifica un errore durante la rimozione, visualizza un messaggio di errore
                console.error(error);
                alert('Si è verificato un errore durante la rimozione del prodotto dal carrello.');
            }
        });
    }
            document.getElementById("dataScadenzaCarta").addEventListener("blur", function () {
                var inputDate = this.value;
                var pattern = /^(0[1-9]|1[0-2])\/\d{2}$/; // Formato MM/AA
                if (!pattern.test(inputDate)) {
                    alert("Formato data non valido. Inserisci la data nel formato MM/AA.");
                    this.value = ""; // Cancella il campo
                }
            });

            $(document).ready(function () {
                // Aggiungi un gestore di eventi per rilevare le modifiche alla quantità dei prodotti
                $('.quantita-prodotto').on('input', function () {
                    // Calcola il nuovo totale della spesa
                    var totaleSpesa = 0;
                    $('.quantita-prodotto').each(function () {
                        var quantita = $(this).val();
                        var prezzo = $(this).data('prezzo');
                        totaleSpesa += parseFloat(quantita) * parseFloat(prezzo);
                    });

                    // Aggiorna il testo dell'elemento che mostra il totale della spesa
                    $('#totaleSpesa').text(totaleSpesa.toString() + ' €');
                });
            });
        </script>
    }
}
else
{
    <p>Il carrello è vuoto.</p>
}
